<!--
this style is for the more complex validation check
<style>
  span.error{color:red;}
</style>
-->
<h1>Application Deployer</h1>
<%= form_tag(app_deployer_deploy_app_path, :id => 'app_deployer_form') do |f| %>
    <h3>Select the Application Type</h3>
    <%= field_set_tag 'Select the Application Type' do %>
        <%= label_tag 'application_KOMET', class: 'radio-inline' do %>
            <%= radio_button_tag 'application', 'KOMET', true %>KOMET Tooling Deployment
        <% end %>
        <br/>
        <%= label_tag 'application_ISAAC', class: 'radio-inline' do %>
            <%= radio_button_tag 'application', 'ISAAC' %>ISAAC Deployment
        <% end %>
    <% end %>

    <h3>Select the Application Components</h3>
    <%= field_set_tag 'Select the WAR file to deploy to Tomcat' do %>
        <div id="komet_wars">
          <%= label_tag 'komet_war', 'KOMET Tooling' %><br>
          <%= select_tag 'komet_war', options_from_collection_for_select(@komet_wars, 'select_key', 'select_value'), {:prompt => '-- Select a war to deploy --'} %>
        </div>
        <div id="isaac_wars">
          <%= label_tag 'isaac_war', 'ISAAC Rest' %><br>
          <%= select_tag 'isaac_war', options_from_collection_for_select(@isaac_wars, 'select_key', 'select_value'), {:prompt => '-- Select a war to deploy --'} %>
          <br>
          <br>
          <%= label_tag 'isaac_db', 'ISAAC Database' %><br>
          <%= select_tag 'isaac_db', options_from_collection_for_select(@isaac_dbs, 'select_key', 'select_value'), {:prompt => '-- Select a terminology database --'} %>
        </div>
        <br>
    <% end %>

    <h3>Select the Tomcat Server</h3>
    <%= field_set_tag 'Select Tomcat Server' do %>
        <%= label_tag PrismeService::TOMCAT, 'Tomcat Server URL' %><br>
        <%= select_tag PrismeService::TOMCAT, options_from_collection_for_select(@tomcat_servers, 'select_key', 'select_value'), {:prompt => '-- Select the Tomcat Server --', required: true} %>
    <% end %>

    <h3>Submit Deployment Request</h3>
    <%= field_set_tag 'Application Deployment Summary' do %>
        <p>Please review the deployment summary and click the 'Finish' button to deploy the selected application.
        <br>
          Application to Deploy:
        <ul>
          <li id="summary_application2"></li>
        </ul>

        <table cellpadding="2" cellspacing="5" width="950px">
          <tr>
            <td align="right" width="25%"><b>Application to deploy:</b></td>
            <td width="75%"><span id="summary_application"></span></td>
          </tr>
          <tr>
            <td align="right" width="25%"><b>Selected Components:</b></td>
            <td  width="75%"><span id="summary_components"></span></td>
          </tr>
          <tr>
            <td align="right" width="25%"><b>Tomcat Server:</b></td>
            <td  width="75%"><span id="summary_tomcat"></span></td>
          </tr>
        </table>
        </p>
    <% end %>
<% end %>

<script>
  var selected_app_type = null;

  $(document).ready(function () {
    var form = $('#app_deployer_form');
    form.show();
    form.steps({
      headerTag: "h3",
      bodyTag: "fieldset",
      transitionEffect: "slideLeft",
      onStepChanging: function (event, currentIndex, newIndex) {
        // Always allow previous action even if the current form is not valid!
        if (currentIndex > newIndex) {
          return true;
        }
        if (newIndex === 1) {
          //get the selected radio button for the application to deploy
          selected_app_type = $("input[name=application]:checked").val();

          if (selected_app_type === 'KOMET') {
            $('#komet_wars').show();
            $('#isaac_wars').hide();
            document.getElementById("komet_war").required = true;
            document.getElementById("isaac_war").required = false;
            document.getElementById("isaac_db").required = false;
          }
          else {
            $('#komet_wars').hide();
            $('#isaac_wars').show();
            document.getElementById("komet_war").required = false;
            document.getElementById("isaac_war").required = true;
            document.getElementById("isaac_db").required = true;
          }
          document.getElementById("komet_war").value = '';
          document.getElementById("isaac_war").value = '';
          document.getElementById("isaac_db").value = '';
        }

        // Forbid next action on "Warning" step if the user is to young
        /*
         if (newIndex === 1 && Number($("#age-2").val()) < 18) {
         return false;
         }
         */
        /*
         // Needed in some cases if the user went back (clean up)
         if (currentIndex < newIndex) {
         // To remove error styles
         form.find(".body:eq(" + newIndex + ") label.error").remove();
         form.find(".body:eq(" + newIndex + ") .error").removeClass("error");
         }
         form.validate().settings.ignore = ":disabled,:hidden";
         */
        return form.valid();
      },
      onStepChanged: function (event, currentIndex, priorIndex) {
        if (currentIndex === 1) {
          //get the selected radio button for the application to deploy
          var war_filter = $("input[name=application]:checked").val();
          $('#summary_application').text(war_filter === 'KOMET' ? 'KOMET Tooling Deployment' : 'ISAAC Deployment');
        }
        if (currentIndex === 2) {
          var components = 'kma bobo';

          if (selected_app_type === 'KOMET') {

          }
          else {

          }
          $('#summary_components').text(components);
        }

        if (currentIndex === 3) {
          var tomcat = document.getElementById("tomcat").value;
          $('#summary_tomcat').text(tomcat);
        }
      }
      ,
      onFinishing: function (event, currentIndex) {
        form.validate().settings.ignore = ":disabled";
        return form.valid();
      }
      ,
      onFinished: function (event, currentIndex) {
        form.submit();
      }
    }).validate({
      /*      errorPlacement: function(error, element) {
       // Append error within linked label
       $( element )
       .closest( "form" )
       .find( "label[for='" + element.attr( "id" ) + "']" )
       .append( error );
       },
       errorElement: "span",
       messages: {
       komet_wars: {
       required: " (required)",
       minlength: " (must be at least 3 characters)"
       }
       }*/
      errorPlacement: function errorPlacement(error, element) {
        element.after(error);
      }
      /*
       rules: {
       confirm: {
       equalTo: "#password-2"
       }
       }
       */
    });
  });
</script>
